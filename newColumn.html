<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Title Page</title>
    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript">
      /// Global variables
    
      var col1;//=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
      var node;// nodeno 0 - basestation,1-laptop ,2 -phone etc
            var x1;//= [2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40];
            var y1;//= [10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10];
            var m1;//=[1,3,4,6,7,9,11,13,14,15];
            var m2;//=[1,6,10,15,40,35,21,24,15,7];//Default initialisation
            var dict= [{Col:-1,Attr:"default"}];//for dictionary, has to be array for push
            var currMap=[];//current mapping of metrics to attributes
            var map=[0,1,2,3,4];//Original mapping
            var idtochange="";//to identify the circle clicked
             var mapctr=1;//mapctr is to identify when map should be [] again ,for ex on AddData as map is altered  

     
            //col1 stores col0 of tanle
            //x1 stores col1 of table,assuming it to be X axis
            //y1 stores col2 od table assuming it to be Y axis
            //m1 always stores metric for size, originally col3
            //m2 always stores metric for colour,originally col4
            //Above have been written as col,but is actually rows in csv file,as I could not do column parsing 
            //using d3.csv
      var table,table1;//to store the csv file
      var margin;
      var xfact,yfact,rfact,min1,max1;//these variables control the scaling of the respective paramters
           //can be controllled by user if necessary
           rfact=2;//global
      var svg,svgContainer;
    </script>


    <style>
 
   svgContainer {
  font: 10px sans-serif;
  shape-rendering: crispEdges;
   }
  rect {
  fill: #ddd;
  }
  .axis path,
 .axis line {
  fill: none;
  stroke: #fff;
  }
 
   </style>
  </head>
  <body>
    <h1 class="text-center">Graph</h1>
    <div class="panel panel-default">
      <div class="panel-body">
        <div class="well">
           <div id="drawbox"> </div>
          </div>
      <button type="button" class="btn btn-default" onclick="loadMe()">Load Graphics</button>
      <button type="button" class="btn btn-default" onclick="doPlot()">Plot Initial</button>
        </div>
      </div>
        <div>
           <div class="panel panel-default">
             <div class="panel-body">

            


              
               <p id="MapOutput">
                  Map
                <!--To print the value of Form output  -->
               </p>
             </div>
           </div>

        </div>
        <div>
           <div class="panel panel-default">
             <div class="panel-body">
              <form id="putdata">
                Xaxis <input type="number" step="0.0000000001">
                Yaxis<input type="number" step="0.0000000001">
                Size<input type="number" step="0.0000000001">
                Colour<input type="number" step="0.0000000001">
              </form>
              <p id="Form2Output">No circle has been clicked yet</p>
               <button type="button" class="btn btn-default" onclick="Addchange()">Make Changes and Plot</button>
                
                 <button type="button" class="btn btn-default" onclick="ResetChange()">ReSet Changes</button> 
             </div>
           </div>
        </div>
        
           
      

  <!-- jQuery -->
  <script src="js/jquery.js"></script>
  <!-- Bootstrap JavaScript -->
  <script src="/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/d3/d3.min.js"></script>
  
  <script type="text/javascript">
function SetSize(){
     margin = {top: 0, right: 10, bottom: 15, left: 100},
    width = 900 //- margin.left - margin.right,
    height = 400 //- margin.top - margin.bottom;
var x = d3.scale.linear()
    .domain([0, (width )]) // changes range of values for x axis
    .range([0, width]);
var y = d3.scale.linear()
    .domain([0, height ]) // changes range of values for y axis
    .range([height, 0]);
var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(20)
    .tickSize(-height);
var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(10)
    .tickSize(-width);
var zoom = d3.behavior.zoom()
    .x(x)
    .y(y)
    .scaleExtent([0.01,10000 ])   //this controls maximum zooming amount
    .center([width / 2, height / 2])
    .size([width, height])
    .on("zoom", zoomed);
svg = d3.select("#drawbox").append("svg").attr("width", width+margin.left + margin.right).attr("height", height+margin.top + margin.bottom)
 .append("g")
    .call(zoom);
 d3.select("button").on("click", reset);
svg.append("rect")
    .attr("width", width+margin.left + margin.right )
    .attr("height", height+margin.top + margin.bottom);
  svgContainer=svg.append("g");
svgContainer.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);
svgContainer.append("g")
    .attr("class", "y axis")
    .call(yAxis);
}
function loadMe(){
  SetSize();
  d3.text("testfile4.csv", fillData);
   
   function fillData(text){
   console.log("Read this ",text);
  var data = d3.csv.parseRows(text).map(function(row) {
  return row.map(function(value) {
  return +value;    //to convert text to numbers
  });
  });
  console.log(data);
  table=data;   //Taking data from respective rows
  table1=data;
   console.log("Before loading",table);
  }
    console.log("After loading",table);
  // window.alert("hello");
  }
  
  function doPlot(){
    //m1 and m2 varying along both x and y axis
  //m1 is represented as radius,m2 in color using some sort of gray scale,minimum is white and maximum is black
  //m3 is just a dummy column for now
  col1=table[0];
  node=table[1]
    x1=table[2];   
    y1=table[3];
    m1=table[4];
    m2=table[5];
   // m3=table[5];
  xfact=40; 
  yfact=20;
   rfact=15/((Math.min.apply(null,m1)+Math.max.apply(null,m1))/2);//temporary,should change later
 // window.alert(rfact);  
  //rfact changes made above
  min1=Math.min.apply(null,m2);
  max1=Math.max.apply(null,m2);
 
  for(i=0;i<col1.length;i++)
  {
 Circles=svgContainer.append("circle").attr("id","circle"+i).attr("cx",20).attr("cy", 100).attr("r",rfact*m1[i]).attr("style","fill:rgb(0,0,0) ;stroke: blue ;stroke-width: 2");//.on("click",function(){ alert(cx.value)});
  
  console.log(Circles);
  }
  Circles=d3.selectAll("circle");
    
  
  Circles.on("click", function () {
  alert("clicked");
 var display="";
  display+="Id  "+this.id+"<br>";
  //Use currMap to get right Column Mapping and not just hard code it 
  display+="Column 1 Value "+" "+(this.cx.animVal.value+100-margin.left)/xfact+" "+"   Xaxis Value "+(this.cx.animVal.value+100-margin.left)+"<br>";
  display+="Column "+map[2]+" Value"+" "+(height-this.cy.animVal.value)/yfact+" "+"   YaxisValue "+" "+(height-this.cy.animVal.value) +"<br>";
  display+="Column "+ map[3]+" Value" + " "+ this.r.animVal.value/rfact+"  "+"    Radius Value "+" "+this.r.animVal.value+"<br>";
  var  b=this.style.fill;
  var a = b.split("(")[1].split(")")[0];
  a = a.split(",");
  //alert(a);//a has the 3 r,g,b values while var b had string of rgb values
  display+="Column " +map[4]+" value"+" "+(max1-((a[0]*(max1-min1))/255))+"    Colour Value"+ "  " + a+"<br>";
  idtochange=this.id;
 document.getElementById("Form2Output").innerHTML=display;
  });//function to put values of circle on click
svgContainer.append("rect").attr("x", margin.left-100).attr("y",height-5).attr("width",10).attr("height",10).attr("style","fill:rgb(255,0,0) ;stroke: blue ;stroke-width: 2");//ORIGIN ,the number 100 has to be seen to compensate for the origin shift
  d3.selectAll("circle").data(m2).style('fill', function(d){return d3.rgb(((max1-d)*255/(max1-min1)),((max1-d)*255/(max1-min1)),((max1-d)*255/(max1-min1)))});
  d3.selectAll("circle").data(x1).attr("cx",function(d){return margin.left-100+xfact*d});
  d3.selectAll("circle").data(y1).attr("cy",function(d){return height-(yfact*d)});
  }
  function zoomed() {
  // svg.select(".x.axis").call(xAxis);
  // svg.select(".y.axis").call(yAxis); //above two causes fixed axis
  
  svgContainer.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
  //above line causes movement also
  
    }//above function causes zooming which is called in var zoom
  function reset() {
  svgContainer.call(zoom
  .x(x.domain([-width / 2, width / 2]))
  .y(y.domain([-height / 2, height / 2]))
  .event);
  }
    



function RePlot(){
    //m1 and m2 varying along both x and y axis
  //m1 is represented as radius,m2 in color using some sort of gray scale,minimum is white and maximum is black
  //m3 is just a dummy column for now

 mapctr=1;
  // col1=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
   // x1= [2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40];
    y1= [10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10];
    m1=[10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10];
    m2=[10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10];
 
  if(map[0]!=-1)
   col1=table[map[0]];
  if(map[1]!=-1)
    x1=table[map[2]];
  if(map[2]!=-1)
    y1=table[map[3]];
  if(map[3]!=-1)
    m1=table[map[4]];
  if(map[4]!=-1)
    m2=table[map[5]];

 //   var disp1="";
   //   disp1+="Nothing Added";
    //  document.getElementById("FormOutput").innerHTML=disp1;//Setting paragraph to Null 
       dict=[{Col:-1,Attr:"default"}];//Setting Dictionary to Null
  console.log(col1,x1,y1,m1,m2);
  
  //rfact=15/((Math.min.apply(null,m1)+Math.max.apply(null,m1))/2);//temporary,should change later
 // window.alert(rfact);
  min1=Math.min.apply(null,m2);
  max1=Math.max.apply(null,m2);
 svgContainer.append("rect").attr("x", margin.left-100).attr("y",height-5).attr("width",10).attr("height",10).attr("style","fill:rgb(255,0,0) ;stroke: blue ;stroke-width: 2");//ORIGIN ,the number 100 has to be seen to compensate for the origin shift
  d3.selectAll("circle").data(m2).style('fill', function(d){return d3.rgb(((max1-d)*255/(max1-min1)),((max1-d)*255/(max1-min1)),((max1-d)*255/(max1-min1)))});
  d3.selectAll("circle").data(x1).attr("cx",function(d){return margin.left-100+xfact*d});
  d3.selectAll("circle").data(y1).attr("cy",function(d){return height-(yfact*d)});
  d3.selectAll("circle").data(m1).attr("r",function(d){return rfact*d});
  }
  




function ResetChange(){//Function to reset changes to dictionary
      dict=[{Col:-1,Attr:"default"}];
      RePlot();
      var disp="";
      disp+="Nothing Added";
      document.getElementById("FormOutput").innerHTML=disp;
  }





function Addchange(){ 


  var dat1 = document.getElementById("putdata");  //gets data from form
  // Send Data to Backend for Recalculating
  BackObj={Id:idtochange,Column1:parseFloat(dat1[0].value/xfact),Column2:parseFloat(dat1[1].value/yfact),Column3:parseFloat(dat1[2].value),Column4:parseFloat(dat1[3].value)};//Creating object to send to backend
  // var resobject;
  // BackGet=
  $.post("http://localhost:8080/update",JSON.stringify(BackObj),onsuccess,"json");//getting from server
  //BackGet.responseText has the values
 
  // //alert(BackGet.responseText);
  // console.log("Trying to parse ",BackGet);
  // var a =BackGet.responseText; //Error in this line,if i breakpoint here ,it works
  //  //alert(BackGet.responseText);
  //  console.log("Trying to parse ",a);
  //  ParsedData=JSON.parse(a);
  //  console.log("Parsed Data =  ",ParsedData);
  //  ParsedData=BackGet.responseText;
  
}




 function onsuccess(obj) {
     /* body... */ 
  var dat1 = document.getElementById("putdata");  //gets data from form
  
   console.log("Received this obj",obj);   
ParsedData=obj;
  dat1[0].value=xfact*ParsedData.Column1;
    dat1[1].value=yfact*ParsedData.Column2;
    dat1[2].value=ParsedData.Column3;
    dat1[3].value=ParsedData.Column4;
  //Backend Part Over
   var shape1=document.getElementById(idtochange); 
   var idno=parseInt(idtochange.replace( /^\D+/g, ''));
  x1[idno]=(dat1[0].value-margin.left+100)/xfact;
  y1[idno]=(dat1[1].value)/yfact;
  if(map[3]!=-1)
  m1[idno]=parseFloat(dat1[map[3]-1].value);
else 
  m1[idno]=10;//default value
if(map[4]!=-1)
  m2[idno]=parseFloat(dat1[map[4]-1].value);
else
  m2[idno]=10;//default value
  
  /*
  Should do this for generalised data
  var i=0;
   for(i=3;i<map.length;i++)
  {  //i=0,1,2 are all col1,x1 and y1
    if(map[i]!=-1)
  table[i][idno]=parseFloat(dat1[map[i]-1].value);
  } 
  */
  
 // table1;
   var shape1=document.getElementById(idtochange); 
 min1=Math.min.apply(null,m2);
  max1=Math.max.apply(null,m2);
//changing attributes
 d3.select(shape1).attr("cx",dat1[0].value)
.attr("cy",function(d){
  return (height-dat1[1].value)})
.attr("r",function(d){return rfact*m1[idno]})
.style('fill', function(d){return d3.rgb(((max1-m2[idno])*255/(max1-min1)),((max1-m2[idno])*255/(max1-min1)),((max1-m2[idno])*255/(max1-min1)))});
//Experimental below
/*
   d3.select(shape1).data(x1).attr("cx",function(d){  
     d=dat1[0].value;
     return margin.left-100+xfact*d});
 d3.select(shape1).data(y1).attr("cy",function(d){  
     d=dat1[1].value;
     return height-(yfact*dat1[1].value)});
d3.select(shape1).data(m1).attr("r",function(d){  
     d=dat1[3].value;
     return rfact*dat1[3].value });
d3.select(shape1).data(m2).style('fill', function(d){
  d=dat1[2].value;
  return d3.rgb(((max1-d)*255/(max1-min1)),((max1-d)*255/(max1-min1)),((max1-d)*255/(max1-min1)))});
*/
//Writing changes on paragraph display
var display="";
  display+="id"+" " +idtochange+"<br>";
  display+="Column 1 Value"+" " +dat1[0].value/xfact +" "+" XaxisValue "+" "+dat1[0].value+"<br>";
  display+="Column 2 Value"+ " " +dat1[1].value/yfact+" YaxisValue "+" "+dat1[1].value +"<br>";
  display+="Column 3 value"+ "  "+dat1[2].value+"  Radius Value "+" "+rfact*dat1[2].value+"<br>";
  display+="Column 4 value"+ "  "+dat1[3].value+"  Color Value "+" "+((max1-dat1[3].value)*255/(max1-min1))+","+((max1-dat1[3].value)*255/(max1-min1))+","+((max1-dat1[3].value)*255/(max1-min1))+"<br>";
 document.getElementById("Form2Output").innerHTML=display;
  }


</script> 
</body>
</html>



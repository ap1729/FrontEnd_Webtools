<!--NOTE: Every x,y coord has to be plotted as x(xactual),y(yactual) -->    
<!-- Line 768 to increase number of hexagons
var x = d3.scale.linear()
    .domain([-2200, (2300 )]) // changes range of values for x axis
    .range([0, 900]); //900 is width value which is defined in Setsize()
var y = d3.scale.linear()
    .domain([-2200, 2300 ]) // changes range of values for y axis
    .range([900, 0]);//900 is height value defined in SetSize()
-->
<!DOCTYPE html>

<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sectoring</title>
    <!-- Bootstrap CSS -->

  <script src="/bower_components/jquery/dist/jquery.min.js" type="text/javascript" charset="utf-8" async defer></script>
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">   
    <script src="/bower_components/d3/d3.js" type="text/javascript" charset="utf-8" async defer></script>
    <script type="text/javascript" src="/js/jquery.js"></script>
      <script src="/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.js"></script> 

<script type="text/javascript">
    $(function () {
        $("[rel='tooltip']").tooltip();
    });
</script>


    <style type="text/css">

svg {
    border: none;
    background: white;
}

.bounds {
    stroke: red;
    fill: none;
}

.tile {
    stroke: black;
    stroke-width: 1px;
    fill: black;
    fill-opacity: 0.05;
}


.ue {
  
  stroke: steelblue;
  stroke-width: 0.6px;
}

.bs{
  stroke: pink ;
  stroke-width: 1px;
}

.over {
    fill: black!important;  /* to show selected on hover*/    
    fill-opacity: 0.8 !important;
  }

.inactive{
  fill: black!important;
  fill-opacity: 0.15;
}  


div.visible {
    visibility: visible !important;
}

.loader {
    border: 16px solid #f3f3f3; /* Light grey */
    border-top: 16px solid #3498db; /* Blue */
    border-radius: 50%;
    position:absolute;
    top:400px;
    left:600px;
    width: 120px;
    height: 120px;
    display: none;
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.row.vdivide [class*='col-']:not(:last-child):after {
  background: #e0e0e0;
  width: 1px;
  content: "";
  display:block;
  position: absolute;
  top:0;
  bottom: 0;
  right: 0;
  min-height: 70px;
}

           dt {
          width: 20px;
          height: 20px;
          display: inline-block;
          overflow: hidden;
          border: 1px solid #000;
          }

          .lime {background-color: lime; color: lime; }
          .orange {background-color: orange; color: orange; }
          .red {background-color: red; color: red; }
          .brown {background-color: brown; color: brown; }
          .circle{border-radius: 50%;}
          .rect1{}
          dd {
          display: inline-block;
          width: 7em;
          margin: 0 0 0 1em;
          }/* above is for legend*/
          .legend{font: 20px sans-serif;color:steelblue;};

field{
  text-align:left;
}
   svgContainer {
  font: 10px sans-serif;
  shape-rendering: crispEdges;
   }
  rect {
  fill: #ddd;
  }
  .axis path,
 .axis line {
  fill: none;
  stroke: #fff;
  }
 
   </style>
  </head>
  <body>
<nav class="navbar navbar-default " role="navigation">
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid" id="NavBar">
    </div>
  </div><!--- navigationbar-->
</nav>
<script src="NavBar.js"></script>
<!--<div class="panel-heading">Master Control</div>-->

   <h1 class="text-center">Hexagonal Grid</h1>
    <div class="panel panel-default">
       <div class="panel-body">
       
          <div class="well">
                <div class="row vdivide">
           <div id="drawbox" class="col-sm-10 text-center"> 

              <dl>
                <dd class="legend">LEGEND</dd>       
                <dt class="lime"></dt>
                <dd>Operator 1</dd>
                <dt class="orange"></dt>
                <dd>Operator 2</dd>
                <dt class="red"></dt>
                <dd>Operator 3</dd>
                <dt class="brown"></dt>
                <dd>Operator 4</dd>
                <dt class="circle"></dt>
                <dd> UE(user) </dd>
                <dt class="rect1"></dt>
                <dd> eNodeB(Basestation) </dd>
            </dl>
          <div class="loader" id="loader"></div>
          </div>
         
         
      
              
                  <div class="col-sm-2 text-center">
                  <form>
                   <fieldset class="field">
                      <legend >Control Parameters</legend>

                     
                        No of BS <input id="TopBSno" type="number" style="width: 20%;" step="1" value="10" title="No of BS seen in SIR profile" data-toggle="tooltip">  
                       
                        <br>
                        No.IC<input id="topx" type="number" style="width: 20%;" step="1" value="3" title="No of Interference cancellers" data-toggle="tooltip">
                        <br>
                        POPUP ACTIVE: <input type="checkbox" id="popup" title="Shows SIR profile in new window" data-toggle="tooltip">
                        <br>
                        View Top BS: <input type="checkbox" id="TopBS" title="See Top interfering basestations enlarged" data-toggle="tooltip">
                        <br>
                       FR Mode <select id="FR" title="Choose Frequency reuse mode" data-toggle="tooltip">
                                <option value="FR1">FR1</option>
                                <option value="FR3">FR3</option>
                                <option value="FFR">FFR</option>
                                <option value="AFFR">AFFR</option>
                       </select>
                       <br>
                       
                      Drag Enabled<input type="checkbox" id="dragcheck" > 
                       <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                       VALID OPERATORS  &nbsp; : &nbsp;
                               Operator 1<input type="checkbox" id="Oper1" checked> 
                               Operator 2 <input type="checkbox" id="Oper2" checked> 
                               Operator 3<input type="checkbox" id="Oper3" checked> 
                               Operator 4<input type="checkbox" id="Oper4" checked> 
                                
                       <button type="button" class="btn btn-default" title="Validate your valid operators by clicking to record the change" data-toggle="tooltip"  onclick="validoperator()">Validate</button>
                    <br><br>
                    <legend>Viewing Options</legend>
                           <button type="button" title=" Each ue connects to its operator's strongest eNodeB " data-toggle="tooltip" class="btn btn-default" onclick="level0()">Level0</button>
                           <button type="button" class="btn btn-default" title="Each ue connects to strongest eNodeB" data-toggle="tooltip" onclick="level1()">Level1</button>
                           <button type="button" class="btn btn-default" title="Shows CDF plots of system" data-toggle="tooltip" onclick="CDF()">CDF</button>
                         <br>  <br>Click UE to view SIR profile
                         <br>(graph is plotted below,else check POPUP ACTIVE on the left side)
                </fieldset>
                </form>
             </div>
          </div>
        
      </div>
        </div>
</div> 


<div class="panel panel-default">
     <div class="panel-heading">Outputs</div>
     <div class="panel-body">
          <form id="putdata">
                ROI <input id="LastSIR" type="number" step="0.01"  style="width: 5%;" >    
                Pre SINR <input id="PreSINR" type="number" step="0.01" style="width:5%;"> 
                Post SINR <input id="PostSINR" type="number" step="0.01" style="width: 5%;">              
              </form>
              </div>
            </div>
          
        </div>

      </div>
        <div>
           <div class="panel panel-default">
             <div class="panel-body">SIR PROFILE GRAPH
              <p id="Output">

              <svg id="visual" width="1000" height="500">
   

              </svg>
             <!--  <svg id="text" x="0" y="15"height="30" width="20"><text fill="RED">Nothing clicked</text> </svg>                 -->
               
               </p>
             </div>

           </div>
<canvas id="canvas"></canvas>
<img id="CDFImage"/>
        </div>



  <!-- jQuery -->
  <script src="js/jquery.js"></script>
  <!-- Bootstrap JavaScript -->

 <!-- <script src="//d3js.org/d3.v3.min.js"></script> -->  <!-- Needs internet -->
   <script type="text/javascript" src="/d3/d3.min.js"></script> 
  <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.js"></script> 
 

  <script type="text/javascript">




  var canvas=document.getElementById("canvas");
  var ctx=canvas.getContext("2d"); //for plotting curve

  var xAxis,yAxis;
  var xaxisobject,zoom;
  var dragcheck;//to know if drag is enabled
 // var mycolormap = d3.scale.linear().domain([0 ,300]).range(["red", "green"]);

  var ue=[],bs=[];//stores ue and bs data
  var level=0;//which level it is currently in
  var topBsno=10;//no of Bs to show on click and in bar graph
  var opercolor=[{'color':"lime"},{'color':"orange"},{'color':"red"},{'color':"brown"},{'color':"yellow"}];//add as many as operators
  var bscolor=[{'color':"green"},{'color':"orange"},{'color':"red"},{'color':"brown"},{'color':"yellow"}];//add as many as operators
  var currselected=-1; //latest selected circle
  var wcount=0;//window number for cdf plot
  var wcount1=0;
 // var BScord=[];//basestation coords 
  //var idtochange=""; // for dragging , unnecessary
  

var x = d3.scale.linear()
    .domain([-2200, (2300 )]) // changes range of values for x axis
    .range([0, 900]); //900 is width value which is defined in Setsize()
var y = d3.scale.linear()
    .domain([-2200, 2300 ]) // changes range of values for y axis
    .range([900, 0]);//400 is height value defined in SetSize()

function SetSize(){
     margin = {top: 10, right: 10, bottom: 10, left: -20},
    width = 1400 //1200/to change dimensions of graph  seen///- margin.left - margin.right,
    height = 500 //500//- margin.top - margin.bottom;

  
  xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(0)
    .tickSize(-height);
  yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(0)
    .tickSize(-width);
zoom = d3.behavior.zoom()
    .x(x)
    .y(y)
    .scaleExtent([0.1,10.00 ])   //this controls maximum zooming amount
    .center([x(1000), y(100)])
    .size([3000, 3000])
    .on("zoom", zoomed);




//for basestations
/*var drag1 = d3.behavior.drag()  
    .origin(function(d) { return d; })
    .on("dragstart", dragstarted1)
    .on("drag", dragged1)
    .on("dragend", dragended1);  */  

   //not that 100% is 1400px hence 1% is 14px approx) 
svg = d3.select("#drawbox").append("svg").attr("width", "100%").attr("height", height+margin.top + margin.bottom).attr("pointer-events",'all').call(zoom);;
svgContainer=svg.append("g").attr("id","svgContainer").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

xaxisobject=svgContainer.append("g")
    .attr("class", "x axis")
    .attr("transform",  function(d) {
       var event={translate: [0, 0], scale: 1} ||{};
      var translateX = event.translate[0] || 0,
          translateY = event.translate[1] || 0,
          scale = event.scale;
      return "translate("+translateX+","+translateY+")scale(" + scale + ")";
  })
    .call(xAxis);
svgContainer.append("g")
    .attr("class", "y axis")
    .call(yAxis);
 //window.alert()
 BackObj={perf:"scmeta" };
console.log(JSON.stringify(BackObj));
document.getElementById("loader").style.display = "block";
$.post("/update",JSON.stringify(BackObj),doPlot,"json");
document.getElementById("loader").style.display = "none";


//temporary to make opflags as 1,1,1,1
BackObj1={perf:"enop",opflags:[1,1,1,1]};//params is to which level
 console.log(JSON.stringify(BackObj1));

document.getElementById("loader").style.display = "block";
$.post("/update",JSON.stringify(BackObj1),onsuccess1,"json");//getting from server
document.getElementById("loader").style.display = "none";


}
// d3 mouse events

 
function doPlot(obj) {
  //function to plot ue and bs
  var drag = d3.behavior.drag()
    .origin(function(d) { return d; })
    .on("dragstart", dragstarted)
    .on("drag", dragged)
    .on("dragend", dragended);
  console.log(obj);
  ue=obj.data.users;
  bs=obj.data.basestats;
 var uecircles = svgContainer.selectAll("ue").data(ue).enter().append("circle");
            uecircles.attr("r", function(d,i) { return (3.5);}) 
            .attr("id",function(d,i){ 
              //window.alert(i);
              return "UE"+d.id;

             })
            .attr("class", "ue")
            .attr("cx",function(d,i) { return x(d.x); })
            .attr("cy",function(d,i) { return y(d.y); })  
            .style("fill",function(d,i) { 
                                          return opercolor[d.opid].color;
                                          } ) // to change colour of each basestation user 
            .call(drag)
            .on('mouseover', mouseOver) 
            .on('mousemove', mouseMove)
            .on('mouseout', mouseOut)
            .on('click', click)
            .attr("data-toggle","tooltip");

 var bsrect= svgContainer.selectAll("bs").data(bs).enter().append("rect");
            bsrect.attr("x",function(d,i){
                        if(d.id%3==0) 
                            return x(d.x);
                   else if(d.id%3==1)
                            return x(d.x)+3.1;
                        else 
                           return x(d.x)-3;
                              })
            .attr("y",function(d,i){
                     if(d.id%3==0) 
                            return y(d.y)-5;
                   else if(d.id%3==1)
                            return y(d.y)+1;
                        else 
                           return y(d.y)+1;
                           })  //this 3.5 is to make the point as center of rectangle
            .attr("class", "bs")
            .attr("width",6)
            .attr("height",6)
            .style("fill",function(d,i) { 
                                        return bscolor[d.opid].color;
                                        } ) 
            .attr("id",function(d,i){return "BS"+d.id;})
            .on('mouseover', mouseOver1)
            .attr("data-toggle","tooltip") ;
            // .call(drag1);
}


function mouseOver1(d,i){
  //function for basestation , mouse hover
  //window.alert(0);
   d3.select(this).attr("title","BS" +(d.id));
}
function mouseOver(d, i) {  
  //function for circle,tooltip on mouse hover
//window.alert(1);
    d3.select(this).classed('over', true);
    if(level==0)
    { 
       d3.select(this).attr("title","UE"+d.id);
      }
      else if(level==1)
      {
         var currop="";
         if(this.style.fill=='lime')
         {
           currop=1;//from definition
         }
      else if(this.style.fill=='orange')
         {
           currop=2;//from definition
         }
      else if(this.style.fill=='red')
         {
           currop=3;//from definition
         }
        else if(this.style.fill=='brown')
         {
           currop=4;//from definition
         }
        else if(this.style.fill=='yellow')
        {
         currop=5;
        }
        d3.select(this).attr("title","UE" +(d.id)+" Def:"+d.opid+" Curr:"+currop);

      }
      else
        console.log("Level undefined error");
}

function mouseMove(d, i) {
    
}

function mouseOut(d, i) {
   d3.select(this).classed('over', false);
}

function onsuccess(obj){
console.log(obj);
if(checkerr(obj.status)<0)
{
   console.log("backend error");
} 
else{
//obj.SIR is SIR
//obj.SINR has PreSINr,PostSINR and ROI in a array
//obj.BSid is top x basestation id's
obj.data.post=Math.round(obj.data.post * 100) / 100;
obj.data.pre=Math.round(obj.data.pre * 100) / 100;
obj.data.roi=Math.round(obj.data.roi * 100) / 100;
document.getElementById("LastSIR").value=obj.data.roi;
document.getElementById("PostSINR").value=obj.data.post;
document.getElementById("PreSINR").value=obj.data.pre;

var Bsid="";
  for(i=0;i<bs.length;i++)
  {// to make all rect same size
    Bsid='#BS'+i.toString();
    d3.select(Bsid).attr("width",6).attr("height",6);
  }

if(document.getElementById("TopBS").checked == true)
{//button is also clicked, to enhance size of those basestations

  

  for(i=0;i<topBSno;i++) //top 10 ,hence this loop 
  {
   Bsid="#BS"+obj.data.bsid[i].toString();
  // console.log(Bsid);
   if(Bsid[i]%3==0)
   {
    d3.select(Bsid).attr("width",obj.data.sir[i]-obj.data.sir[topBSno-1]+8 ).attr("height",6);// to change attributes of max basestations
   }
   else if(Bsid[i]%3==1)
   {
  d3.select(Bsid).attr("width",obj.data.sir[i]-obj.data.sir[topBSno-1]+8 ).attr("height",6);    

   }
   else
   {
   d3.select(Bsid).attr("width",6 ).attr("height",obj.data.sir[i]-obj.data.sir[topBSno-1]+8);
   }
  }
}//top rect being enlarged
 
 var barData=[];
  for(i=0;i<obj.data.bsid.length;i++)
  {
    barData.push({'x':obj.data.bsid[i],'y':obj.data.sir[i],'co':obj.data.opno[i]});
  }

PlotBarGraph(barData,obj.data.pre,obj.data.post);

document.getElementById("loader").style.display = "none";
 }
}



function click(d, i) { // on mouse click ,to be used for circles to show SINR profile ,modify it 
   //to send node info to backend and do appropriate calculations
   if(document.getElementById("dragcheck").checked==true)
   {
   if (d3.event.defaultPrevented) {console.log("click suppressed"); return;} // click suppressed
 }
 else
 {
 console.log("clicked!");
// d3.event.sourceEvent.stopPropagation();//silence other listeners
topBSno=document.getElementById("TopBSno").value;
if(topBSno=="")
 topBSno=10;
else
  topBSno=parseInt(topBSno);
currselected=d.id.toString();

topx=document.getElementById("topx").value;

if(topx=="")
 topx=3;
else
  topx=parseInt(topx);

  
//Use this in type for all BackObj to do necessary//console.log(document.getElementById("FR").value);
BackObj={perf:"sir",node:parseInt(d.id),level:level,topbsno:topBSno,noise:-90,intcnc:topx,frmode:document.getElementById("FR").value };
console.log(JSON.stringify(BackObj));
document.getElementById("loader").style.display = "block";
$.post("/update",JSON.stringify(BackObj),onsuccess,"json");//getting from server
//document.getElementById("loader").style.display = "none";
//above change the backend code and do parsing

if(document.getElementById("popup").checked == true)
{
wcount++;
newwindow(d.id);//plot on graph

}

    var element = d3.select(this),
        selected = element.classed('selected');
        
        element.classed('selected', !selected);
        d.type = selected ? 'regular' : 'selected';
        
        if(d.type=="selected")
          d3.select(this).attr("r",10);
        else
          d3.select(this).attr("r",3.5);
  }
}

function PlotBarGraph(barData,prs,pos){
  //function which plots bar graph
  //also increases top contributing basestations sizes  
InitChart(barData);

function InitChart(barData) {

d3.select("#BarGraph").remove();  
     
var key = function(d){
  return d.y;
}

//plotting
  vis = d3.select('#visual').append('svg').attr("id","BarGraph"),
    WIDTH = 700,//change width and height to change size of bar graph
    HEIGHT = 500,PADDING=100,
    MARGINS = {
      top: 20,
      right: 20,
      bottom: 20,
      left: 70
    },
    xRange = d3.scale.ordinal().rangeRoundBands([MARGINS.left, WIDTH - MARGINS.right], 0.1).domain(barData.map(function (d) {
      return (d.x);
    })),


     yRange = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([-100,0]),

    xAxis = d3.svg.axis()
      .scale(xRange)
      .tickSize(5)
      ,

    yAxis = d3.svg.axis()
      .scale(yRange)
      .tickSize(5)
      .orient("left");

/*console.log(barData.map(function (d) {
      return d.x;
    }))*/

 vis.append('svg:g')
    .attr('class', 'x axis')
    .attr('transform', 'translate(0,'  + (HEIGHT - MARGINS.bottom) +  ')')
    .call(xAxis);

  vis.append('svg:g')
    .attr('class', 'y axis')
    .attr('transform' ,'translate(' + (MARGINS.left) + ',0)')
    .call(yAxis);

        vis.selectAll("rect")
      .data(barData)
      .enter()
        .append('rect')
        .attr('x', function (d) {
      return xRange(d.x);
    })
    .attr('y', function (d) {
      return yRange(d.y);
    })
    .attr('width', xRange.rangeBand())
    .attr('height', function (d) {
      return ((HEIGHT - MARGINS.bottom) - yRange(d.y)-45);
    }).style("fill",function(d){return bscolor[d.co].color});

    vis.append("line")                  
  .attr("class", 'd3-dp-line')
    .attr({ x1: MARGINS.left , y1: HEIGHT-65, x2: WIDTH-MARGINS.right, y2: HEIGHT-65 })
    .style("stroke-dasharray", ("10, 10"))
    .style("stroke-opacity", 2)
    .style("stroke-width",3)
    .style("stroke", "red");

 
    
vis.append("text")
    .attr("text-anchor", "middle")
    .attr("transform", "translate("+ (MARGINS.left -35) +","+(HEIGHT/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
    .text("Magnitude in dBm");

    


    vis.append("text")
    .attr("text-anchor", "right")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ WIDTH +","+(HEIGHT - MARGINS.top+20)+")")  // centre below axis
    .text("BS ID");

    

    
    vis.append("text")
    .attr("text-anchor", "right")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ WIDTH +","+(HEIGHT - 65)+")")  // centre below axis
    .text("Noise floor");


vis.append("text")                  
  .attr("x",(WIDTH/4)-40)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text("UE: ");


vis.append("text")                  
  .attr("x", (WIDTH/4)+50)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text("Level: ");

    vis.append("text")                  
  .attr("x", (WIDTH/4)+150)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text("FR Mode: ");

vis.append("text")                  
  .attr("x", WIDTH/2+110)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text("Pre SINR: ");

vis.append("text")                  
  .attr("x", WIDTH*(3/4)+90)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text("Post SINR: ");


vis.append("text")                  
  .attr("x", (WIDTH/4))
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text(currselected);

vis.append("text")                  
  .attr("x", (WIDTH/4)+80)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text(level);

vis.append("text")                  
  .attr("x", (WIDTH/4)+205)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text(document.getElementById("FR").value);
vis.append("text")                  
  .attr("x", (WIDTH/2)+180)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text(prs);

vis.append("text")                  
  .attr("x", WIDTH*(3/4)+160)
    .attr("y",MARGINS.top-3)
    .attr("text-anchor","middle")
    .text(pos);               
 }
}



function zoomed() {
  //does pan +zoom
 
 
  
    //console.log("Normal",d3.mouse(this),window.event);
     if(d3.event==null)
     {
      window.alert("please refresh,error in loading zoom");
     }
     else{
  var translate = d3.event.translate,
            scale = d3.event.scale;
        svg.selectAll("circle").attr("transform", "translate(" + translate + ")scale(" + scale + ")");
        svg.selectAll("rect").attr("transform", "translate(" + translate + ")scale(" + scale + ")");
        svg.selectAll('.tile').attr("transform", "translate(" + translate + ")scale(" + scale + ")");
    }

     

  }//above function causes zooming which is called in var zoom
    

function validoperator(){
  //function to return a array of 0 and 1's to indicate which operators are valid
  a=[1,1,1,1];
//doing inactive visual

 var Bsid="";
 for(j=0;j<4;j++)
 { //for each operator
    if(document.getElementById("Oper"+(j+1).toString()).checked)//check if operator is checked or not 
  {
     a[j]=1;    
  }
   else
   {
      a[j]=0;
   }
 }
console.log(a);
   for(i=0;i<bs.length;i++)
   {//for all bs
     Bsid='#BS'+i.toString();
       if(a[bs[i].opid]==1)
      {
        d3.select(Bsid).classed('inactive',false);
       }
       else
        {
         d3.select(Bsid).classed('inactive',true);
        }

    }

 
  //return a;
BackObj={perf:"enop",opflags:a};//params is to which level
 console.log(JSON.stringify(BackObj));

document.getElementById("loader").style.display = "block";
$.post("/update",JSON.stringify(BackObj),onsuccess1,"json");//getting from server
document.getElementById("loader").style.display = "none";

}



function onsuccess1(obj)
{
 console.log(obj);
if(checkerr(obj.status)<0)
{
 console.log("error");
}
else{


//UE id starts from UE0
str1="#UE";
 for(i=0;i<obj.data.opconn.length;i++)
   {
    str2=str1+(i).toString();//UE id starts from UE0 for sectoring
    d3.select(str2).style("fill",opercolor[obj.data.opconn[i]].color);
   }
   
  }
}


function level1()
{



//console.log("BBBBBB",currselected);//row no 
topBSno=document.getElementById("TopBSno").value;
if(topBSno=="")
 topBSno=10;
else
  topBSno=parseInt(topBSno);




BackObj={perf:"lvlchng",params:1,frmode:document.getElementById("FR").value };//params is to which level
 console.log(JSON.stringify(BackObj));

document.getElementById("loader").style.display = "block";
$.post("/update",JSON.stringify(BackObj),onsuccess1,"json");//getting from server
//document.getElementById("loader").style.display = "none";

level=1;//updating level 
//console.log(document.getElementById("loader").style.display);
topx=document.getElementById("topx").value;

document.getElementById("loader").style.display = "none"; 


if(topx=="")
 topx=3;
else
  topx=parseInt(topx);
if(currselected!=-1) 
{

BackObj1={perf:"sir",node:parseInt(currselected),level:level,topbsno:topBSno,noise:-90,intcnc:topx,frmode:document.getElementById("FR").value };
console.log(JSON.stringify(BackObj1));
$.post("/update",JSON.stringify(BackObj1),onsuccess,"json");//getting from server
}

}


function level0()
{ //level 0 reset
  level=0;
document.getElementById("loader").style.display = "block";

BackObj={perf:"lvlchng",params:0,frmode:document.getElementById("FR").value };//params is to which level
 console.log(JSON.stringify(BackObj));


$.post("/update",JSON.stringify(BackObj),onsuccess1,"json");//getting from server

console.log("reached level 0");
topBSno=document.getElementById("TopBSno").value;
if(topBSno=="")
 topBSno=10;
else
  topBSno=parseInt(topBSno);

topx=document.getElementById("topx").value;
if(topx=="")
 topx=3;
else
  topx=parseInt(topx);
if(currselected!=-1)
 { 
BackObj={perf:"sir",node:parseInt(currselected),level:level,topbsno:topBSno,noise:-90,intcnc:topx,frmode:document.getElementById("FR").value };
console.log(JSON.stringify(BackObj));
$.post("/update",JSON.stringify(BackObj),onsuccess,"json");//getting from server 
 }
 document.getElementById("loader").style.display = "none";
}

function Reset()
{
  level0();
   svgContainer.selectAll("rect").attr("width",7).attr("height",7);
}

function loadMe(){
   document.getElementById("LastSIR").disabled = true;
    document.getElementById("PreSINR").disabled = true;
     document.getElementById("PostSINR").disabled = true;
   SetSize();  
}
loadMe(); // This is the function that calls everything


//Hexagon creation here
var data = [];

(function() {
window.onload = function() {
    initialize();
};

var size =  1000/Math.sqrt(3), // hexagon size
    radius = 5, // number of hexagons in a row, to increase
    tilted = false; // true is horizontal alignment

var w = 4000, // width
    h = 0, // height,these two parameters are the ones to shift the hexagons
    padding = 50;

var translate = [0, 0];
 

function initialize() {
      fillMap();
    position();
    render();
}

function fillMap() {
    var id = 0,
        limit1 = 0,
        limit2 = radius;
    for (var j = -radius; j <= radius; j++) {
        var i = limit1;
        while (i <= limit2) {
          
            data.push({
                id: id++,
                coordinates: [i-2, j],  //i-2 to centralise hexagons

                type: 'regular',
               // resource: Math.random() < .005
            });
            i++;
        }
        if (j < 0) {
            limit1--;
        } else {
            limit2--;
        }
    }
}

function position() {
    //Note that stepX:stepY:offset ratio should be const
    var stepX = 1000,// Math.sqrt(3) * size / 2,
        stepY =  500*Math.sqrt(3),//size * 3 / 4 ,
        offset = 500//size / Math.sqrt(3) * 3 / 4
    data.map(function(d) {
        var i = d.coordinates[0],
            j = d.coordinates[1],
              x = stepX * i + (offset * j ) + w / 2 ,
              y = stepY * j  + h / 2;
  //            console.log("AAA",x,y);
        d.centroid = [Math.round(x * 1e2) / 1e2, Math.round(y * 1e2) / 1e2]; //centre of hexagon
        d.visible = 1;//visible everywhere
    });
}

function render() {
    renderMap();
}

function renderMap() {
    var grid = svgContainer.selectAll('polygon.tile')
        .data(getVisibleData(), function(d) { return d.id; });

    grid.enter()
        .sort(function(a, b) { return a.id - b.id; })
        .append('polygon')
        .classed('tile', true)
        .attr('points', function(d) {
            return hex(d.centroid, size, tilted).join(' '); //creates hexagon
        }) .style("pointer-events", "none").attr("transform", "translate(0," + 0 + ")");
 
 var x = d3.scale.linear()
    .domain([-2200, (2300 )]) // changes range of values for x axis
    .range([0, 900]); //900 is width value which is defined in Setsize()
var y = d3.scale.linear()
    .domain([-2200, 2300 ]) // changes range of values for y axis
    .range([900, 0]);//400 is height value defined in SetSize()

  grid.enter()
  .sort(function(a, b) { return a.id - b.id; })
  .append("circle")
  .attr("cx",function(d){ return x(d.centroid[0]); })
  .attr("cy",function(d){ return y(d.centroid[1]);})
  .attr("r", (40)) //radius of 200=40*5 m //linear scale of 5
  .style("fill","none")
  .style("stroke","blue")
  .attr('pointer-events', 'none');
 
  grid.exit().remove();
}



function move(x, y) {
    translate[0] += x;
    translate[1] += y;

    moveMap();
}

function moveMap() {
    var dx = translate[0],
        dy = translate[1];

    // Update data
    data.filter(function(d) {
        var x = d.centroid[0] + dx,
            y = d.centroid[1] + dy;
        return d.visible && outbounds(x, y);
    }).map(function(d) {
        d.visible = false;
        return d;
    });
    
    data.filter(function(d) {
        var x = d.centroid[0] + dx,
            y = d.centroid[1] + dy;
        return !d.visible && !outbounds(x, y);
    }).map(function(d) {
        d.visible = true;
        return d;
    });
    //
    
    renderMap();
    
    svg.selectAll('.tile')
        .attr('transform', 'translate(' + [dx, dy] + ')');
}

function outbounds(x, y) {
    return x < padding || x > w - padding || y < padding || y > h - padding;
}

function removeAll() {
    svg.selectAll('.tile').remove();
}

function hex(centroid) {
    var a = 1000/Math.sqrt(3),//size / 2, 
        b = 500,//(Math.sqrt(3) * a) / 2,
        x = centroid[0],
        y = centroid[1];
    var x1 = d3.scale.linear()
    .domain([-2200, (2300 )]) // changes range of values for x axis
    .range([0, 900]); //900 is width value which is defined in Setsize()
  var y1 = d3.scale.linear()
    .domain([-2200, 2300 ]) // changes range of values for y axis
    .range([900, 0]);//400 is height value defined in SetSize()
    //return  [[x - b, y - a / 2], [x - b, y + a / 2], [x, y + a], [x + b, y + a / 2], [x + b, y - a / 2], [x, y - a]];
        return [[x1(x - b),y1(y - a / 2)], [x1(x - b), y1(y + a/2)], [x1(x), y1(y + a)], [x1(x + b), y1(y + a / 2)], [x1(x + b), y1(y - a / 2)], [x1(x),y1(y - a)]];
}

function mouseScroll(d, i) {
    var e = d3.event,
        delta = e.wheelDelta ? e.wheelDelta : e.detail ? -e.detail : 0;
    if (delta > 0) {
        scrollUp();
    } else {
        scrollDown();
    }
    d3.event.preventDefault();
}
//

function scrollDown() {
    if (size > 20) {
        zoom(-20); // zoom out
    }
}

function scrollUp() {
    if (size < 80) {
        zoom(80); // zoom in
    }
}

function zoom(amount) {
    var proportion = (size + amount) / size,
        dx = translate[0] * proportion - translate[0],
        dy = translate[1] * proportion - translate[1];
    size += amount;
    removeAll();
    position();
    move(dx, dy);
}

function getVisibleData() { 
    return data.filter(function(d) { return d.visible; });
}

})();

var node;
function newwindow(idno){
  //function to open a new window and put graph
  var embedded_svg = document.getElementById("Output");//visual
  //console.log(embedded_svg);
 
  var svg_win = window.open("", "svg_win"+wcount.toString(),"width=500,height=500");
  //var title=svg_win.document.createElement("title")

  var transplanted_svg = svg_win.document.importNode(embedded_svg, true);
  var blank_root = svg_win.document.documentElement;
        svg_win.document.removeChild(blank_root);
        svg_win.document.appendChild(transplanted_svg);
         wcount++;     


}




function CDF()
{
topx=document.getElementById("topx").value;
if(topx=="")
 topx=3;
else
  topx=parseInt(topx);

BackObj={perf:"cdf",intcnc:topx,frmode:document.getElementById("FR").value };
console.log(BackObj);

document.getElementById("loader").style.display = "block";
 $.post("/update",JSON.stringify(BackObj),plotcdf,"json");//getting from server
}

  function va(arr, i, j){
            return [arr[2*j]-arr[2*i], arr[2*j+1]-arr[2*i+1]]
          }
 function ctlpts(x1,y1,x2,y2,x3,y3) {
           // var t = $("tension").value;

         //   var v = va(arguments, 0, 2);
      //      var d01 = dista(arguments, 0, 1);
         //   var d12 = dista(arguments, 1, 2);
        //    var d012 = d01 + d12;
            return [x2 , y2 ,
                    x2 , y2  ];
          }

function plotcdf(obj)
{//cdf to be plotted here
 console.log(obj,"is recieved");
 if(checkerr(obj.status)<0)
{
 console.log(error);
}
else{
 canvas.width = parseInt(2000);
 canvas.height = parseInt(2000);
            
ctx.moveTo(0,0);
ctx.font="30px Arial";//font and size of text
ctx.fillText("CDF CURVES:",600,100);//heading
ctx.fillText(document.getElementById("FR").value,820,100);
plotcurve(obj.data.sinr,obj.data.pre0,"#3399ff");//blue
plotcurve(obj.data.sinr,obj.data.post0,"#ff0066");//pink
plotcurve(obj.data.sinr,obj.data.pre1,"#ff9933");//orange
plotcurve(obj.data.sinr,obj.data.post1,"#800000");//brown
ctx.fillText("SINR value in dBm",600,2500);
//creating legend
ctx.rect(1200,20,500,150);
ctx.stroke();
//
ctx.fillText("LEGEND",1050,40);

ctx.fillStyle="#3399ff";
ctx.fillRect(1210,30,40,40);
ctx.stroke();
ctx.fillStyle="#000000";
ctx.fillText("PrS:0",1260,50);

ctx.fillStyle="#ff0066";
ctx.fillRect(1410,30,40,40);
ctx.stroke();
ctx.fillStyle="#000000";
ctx.fillText("PrS:1",1460,50);

ctx.fillStyle="#ff9933";
ctx.fillRect(1210,90,40,40);
ctx.stroke();
ctx.fillStyle="#000000";
ctx.fillText("PoS:0",1260,110);

ctx.fillStyle="#800000";
ctx.fillRect(1410,90,40,40);
ctx.stroke();
ctx.fillStyle="#000000";
ctx.fillText("PoS:1 ",1460,110);

/*
var dataUrl = canvas.toDataURL('image');

window.open(dataUrl, "toDataURL() image", "width=600, height=200");*/
var image = document.getElementById("CDFImage");
 image.src = canvas.toDataURL("image/png");
 window.open(canvas.toDataURL("image/png"), '_blank');
wcount1+=1;
ctx.clearRect(0, 0, canvas.width, canvas.height);
//plotcurve(obj.Post_sinr_level1_X,obj.Post_sinr_level1_Y,"PoS1");

document.getElementById("loader").style.display = "none";
 }
}
var cdfcount=0;
function plotcurve(xdata,ydata,color)
{


var xpts=[];
var ypts=ydata;
xscale=(canvas.width-200)/ypts.length;
yScale = (canvas.height - 60) ;
//grid
ctx.beginPath();
ctx.strokeStyle="#009933"; // color of grid lines
for(i=0;i<ypts.length/2;i++)
{
   //vertical lines for grid
  ctx.moveTo(90+2*i*xscale,200);
  ctx.lineTo(90+2*i*xscale,1800);
  ctx.stroke();
}
for (i=200;i<=1800;i+=80) {
  //horizontal lines for grid
  ctx.moveTo(90,i);
    ctx.lineTo(canvas.width-100,i);
    ctx.stroke();
    count++;
  }



ctx.strokeStyle=color;//red

//console.log
for(var i=0;i<ypts.length;i++ )
{

 xpts.push(i*xscale + 90);
 ypts[i]=200+(1-ypts[i])*1600;
 //cos left top corrner is 0,0 and y axis is reversed
 showPt(i*xscale +90 , ypts[i], "black");
}

cps = []; // There will be two control points for each "middle" point, 1 ... len-2e
 for (var i = 0; i < xpts.length - 2; i += 1) {
  cps = cps.concat(ctlpts(xpts[i], ypts[i], 
  xpts[i+1], ypts[i+1], 
  xpts[i+2], ypts[i+2]));
drawCurvedPath(cps, xpts,ypts);
  }

//now curve plotted,to put grid,axis and lablels





ctx.moveTo(0, 50);

 
for(i=0;i<xpts.length/2;i++)
{//x axis points
  var x = i * xscale;
  ctx.fillText(Math.round(xdata[2*i]), 2*x+90,1840);//x axis point naming

 ctx.moveTo(x, 50);
}

var count =  0;

  for (i=200;i<=1800;i+=80) {
   
  //  console.log(1.25-(ypts[count]/800));
    ctx.fillText(Math.round((1800-i)/16)/100,20,i)  ;
    

  }

}


 function showPt(x,y,fillStyle) {
            ctx.save();
            ctx.beginPath();
            if (fillStyle) {
              ctx.fillStyle = fillStyle;
            }
            ctx.arc(x, y, 5, 0, 2*Math.PI);
            ctx.fill();
            ctx.restore();
          }
function drawCurvedPath(cps, xpts,ypts){
            var len = xpts.length ; // number of points
            
            
              ctx.beginPath();
              ctx.moveTo(xpts[0], ypts[0]);
              // from point 0 to point 1 is a quadratic
              ctx.quadraticCurveTo(cps[0], cps[1], xpts[1], ypts[1]);
              // for all middle points, connect with bezier
              for (var i = 2; i < len-1; i += 1) {
                // console.log("to", pts[2*i], pts[2*i+1]);
                ctx.bezierCurveTo(
                  cps[(2*(i-1)-1)*2], cps[(2*(i-1)-1)*2+1],
                  cps[(2*(i-1))*2], cps[(2*(i-1))*2+1],
                  xpts[i], ypts[i]);
              }
              ctx.quadraticCurveTo(
                cps[(2*(i-1)-1)*2], cps[(2*(i-1)-1)*2+1],
                xpts[i], ypts[i]);
              ctx.stroke();
            
          }



function dragstarted(d) {
  if(document.getElementById("dragcheck").checked==false)
  {
    if (d3.event.defaultPrevented){ console.log("Drag suprresed");return;} // drag suppressed
  }
else{
  console.log("Drag started");
  d3.event.sourceEvent.stopPropagation();
  d3.select(this).classed("dragging", true);
  console.log(d,d3.event);
var x = d3.scale.linear()
    .domain([-5, (30 )]) // changes range of values for x axis
    .range([0, width]);
var y = d3.scale.linear()
    .domain([-5, 30 ]) // changes range of values for y axis
    .range([height, 0]);
d.x=x.invert(d3.event.sourceEvent.offsetX);
d.y=y.invert(d3.event.sourceEvent.offsetY);
console.log(d3.event);
 d3.select(this).attr("cx", x(d.x)).attr("cy", y(d.y));
 }
}

function checkerr(stat){
  if(stat==0)
    
     return 1;
  else
  { 
    document.getElementById("loader").style.display = "none";
    window.alert("Some Error in Backend ");
    return -1; 
  }
}
function dragged(d) {
 if(document.getElementById("dragcheck").checked==false)
  {
    if (d3.event.defaultPrevented){ console.log("Drag suprresed");return;} // drag suppressed
  }
else{
  if(d3.event.sourceEvent.offsetX>15 && d3.event.sourceEvent.offsetY>15)
  {

d.x=x.invert(d3.event.sourceEvent.offsetX);
d.y=y.invert(d3.event.sourceEvent.offsetY);
//d.x=d3.event.sourceEvent.clientX;//try putting -35 here
//d.y=d3.event.sourceEvent.clientY;
 console.log(d3.event);
 console.log(d3.event.sourceEvent.offsetX,d3.event.sourceEvent.offsetY);
 d3.select(this).attr("cx", x(d.x)).attr("cy", y(d.y));
  } 
 }
}
function dragended(d) {
   if(document.getElementById("dragcheck").checked==false)
  {
    if (d3.event.defaultPrevented){ console.log("Drag suprresed");return;} // drag suppressed
  }
else{
     console.log(d,"ended ",d3.event,this);
 d3.select(this).classed("dragging", false);
  var x = d3.scale.linear()
    .domain([-5, (30 )]) // changes range of values for x axis
    .range([0, width]);
var y = d3.scale.linear()
    .domain([-5, 30 ]) // changes range of values for y axis
    .range([height, 0]);




console.log('Am I at ', x.invert(d.x),y.invert(d.y)) ;
//console.log('But actually at',d.x,d.y,x(d.x),y(d.y));
//Backend Part here
/*  
$.post("http://localhost:8080/update",JSON.stringify(BackObj),onsuccess,"json");//getting from server
*/
 }
}
    </script>

  </body>
</html>